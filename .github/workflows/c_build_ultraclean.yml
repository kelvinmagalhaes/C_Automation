on:
  workflow_dispatch:   
  push:
    branches: ['**']
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Install GCC, Make, Valgrind
    - name: Install build tools
      run: sudo apt-get update && sudo apt-get install -y build-essential valgrind

    # 3️⃣ Setup unique folder per execution
    - name: Setup unique round folder
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        ATTEMPT=${GITHUB_RUN_ATTEMPT}   # unique attempt number for this workflow run
        ROUND_DIR="logs/${TIMESTAMP}_${ATTEMPT}"
        mkdir -p "${ROUND_DIR}"
        echo "ROUND_DIR=${ROUND_DIR}" >> $GITHUB_ENV

    # 4️⃣ Compile project
    - name: Compile with Make
      run: |
        make > "${ROUND_DIR}/build.txt" 2>&1 || true
        if [ ! -s "${ROUND_DIR}/build.txt" ]; then
          rm "${ROUND_DIR}/build.txt"
        fi

    # 5️⃣ Copy input files
    - name: Copy input files
      run: |
        if [ -d input ]; then
          cp input/* "${ROUND_DIR}/"
        fi

    # 6️⃣ Run program
    - name: Run Program
      run: |
        if [ -f "${ROUND_DIR}/input.txt" ]; then
          echo "=== Program Output ==="
          ./challenge < "${ROUND_DIR}/input.txt" 2>&1 | tee "${ROUND_DIR}/output.txt"
        else
          echo "=== Program Output ==="
          ./challenge 2>&1 | tee "${ROUND_DIR}/output.txt"
        fi

    # 7️⃣ Run Valgrind
    - name: Run Valgrind
      run: |
        echo "=== Valgrind Output ==="
        valgrind --leak-check=full --track-origins=yes ./challenge 2>&1 | tee "${ROUND_DIR}/valgrind.txt"

    # 8️⃣ Create combined log
    - name: Create Combined Log
      run: |
        cat "${ROUND_DIR}/output.txt" "${ROUND_DIR}/valgrind.txt" > "${ROUND_DIR}/combined.txt"

    # 9️⃣ Upload logs as artifact
    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: challenge-logs-${{ github.run_id }}-${{ github.run_attempt }}
        path: logs/